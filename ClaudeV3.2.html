<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Belastungskonto 3.8</title>
<style>
:root {
  --green:#34c759; --yellow:#ffcc00; --orange:#ff9500; --red:#ff3b30;
  --blue:#007aff;  --gray:#8e8e93;   --pause:#5856d6;
}
* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:-apple-system,system-ui,sans-serif; background:#f2f2f7; margin:0; padding:12px; padding-top:85px; }
.card { background:#fff; border-radius:16px; padding:16px; margin-bottom:12px; box-shadow:0 4px 12px rgba(0,0,0,.08); }

/* Buttons – alle explizit, kein globales button{} */
.btn-full  { display:block; width:100%; padding:14px; border:none; border-radius:12px; font-weight:700; font-size:16px; color:#fff; cursor:pointer; }
.btn-start { background:var(–blue);   margin-top:12px; }
.btn-reset { background:var(–gray);   margin-top:8px; font-size:13px; }
.btn-pause { background:var(–pause);  margin-bottom:4px; display:none; }
.btn-undo  { background:var(–orange); margin-top:15px; }
.btn-add   { background:var(–green);  border:none; border-radius:10px; padding:10px 14px; font-weight:700; font-size:16px; color:#fff; cursor:pointer; margin-top:6px; white-space:nowrap; }
.btn-alpha { background:var(–blue);   border:none; border-radius:10px; padding:8px 14px; font-weight:700; font-size:13px; color:#fff; cursor:pointer; margin-top:10px; }
.btn-sm    { width:38px; height:38px; padding:0; margin:0 0 0 5px; border:none; border-radius:10px; font-size:17px; color:#fff; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; flex-shrink:0; font-weight:700; }

/* Inline-Edit-Zeile */
.edit-row  { display:none; padding:10px 0 12px; border-bottom:1px solid #eee; gap:6px; flex-wrap:wrap; }
.edit-row.open { display:flex; }
.edit-row input { flex:1; min-width:80px; padding:9px 10px; border:1.5px solid var(–blue); border-radius:9px; font-size:15px; margin:0; }
.edit-row input.pts { flex:0 0 68px; }
.edit-row .save-btn { background:var(–blue);  border:none; border-radius:9px; padding:9px 14px; font-weight:700; font-size:14px; color:#fff; cursor:pointer; white-space:nowrap; }
.edit-row .del-btn  { background:var(–red);   border:none; border-radius:9px; padding:9px 14px; font-weight:700; font-size:14px; color:#fff; cursor:pointer; white-space:nowrap; }
.edit-row .can-btn  { background:var(–gray);  border:none; border-radius:9px; padding:9px 14px; font-weight:700; font-size:14px; color:#fff; cursor:pointer; white-space:nowrap; }

/* Status */
.status-wrap { display:none; gap:10px; margin-bottom:12px; }
.status  { flex:1; border-radius:14px; padding:14px; color:#fff; font-weight:800; text-align:center; }
.big     { font-size:2rem; display:block; margin:5px 0; }
.bg-green  { background:var(–green)  !important; }
.bg-yellow { background:var(–yellow) !important; color:#000 !important; }
.bg-orange { background:var(–orange) !important; }
.bg-red    { background:var(–red)    !important; }

#pacingHeader { position:fixed; top:0; left:0; width:100%; padding:10px; text-align:center; font-weight:800; z-index:2000; display:none; box-shadow:0 2px 10px rgba(0,0,0,.2); }

body { transition: background 0.6s ease; }
.warn-rot  { background:var(–red); color:#fff; }
.warn-pene { background:#000; color:var(–yellow); border-bottom:3px solid var(–red); }
.blink { animation:blinker .9s linear infinite; }
@keyframes blinker { 50%{opacity:.3;} }

.rolling-warn { background:#ffedea; border:2px solid var(–red); color:var(–red); padding:12px; border-radius:12px; font-weight:bold; margin-bottom:15px; display:none; text-align:center; }

.item { display:flex; justify-content:space-between; align-items:center; padding:10px 0; border-bottom:1px solid #eee; }
.drag-handle { font-size:20px; color:#c7c7cc; padding:0 10px 0 0; flex-shrink:0; user-select:none; line-height:1; cursor:grab; touch-action:none; }
.item-name   { flex-grow:1; font-size:16px; padding:6px 0; }
.item-btns   { display:flex; align-items:center; }
.time-label  { font-size:11px; color:var(–gray); margin-right:8px; }

.pause-hint { display:none; font-size:12px; color:#555; background:#e5e5ea; padding:8px; border-radius:8px; margin-bottom:12px; line-height:1.4; border-left:4px solid var(–pause); }
input, select { width:100%; padding:12px; border:1px solid #d1d1d6; border-radius:10px; font-size:16px; margin-top:6px; }
.add-row   { display:flex; gap:6px; align-items:flex-end; }
.flex-name { flex:2; }
.flex-pts  { flex:0 0 72px; }
.toolbar   { display:flex; justify-content:flex-end; margin-top:8px; }
.sort-hint { font-size:11px; color:var(–gray); margin-top:6px; text-align:center; }
</style>

</head>
<body>

<div id="pacingHeader"></div>

<div id="statusWrap" class="status-wrap">
  <div class="status bg-green">Tageslimit<span id="valStart" class="big">0</span></div>
  <div id="boxRest" class="status bg-green">Rest-Energie<span id="valRest" class="big">0</span><span id="statusText"></span></div>
</div>

<button id="pauseBtn" class="btn-full btn-pause" onclick="doPause()">☕ PAUSE (+3 & Block-Reset)</button>

<div id="pauseHint" class="pause-hint">
  <strong>Hinweis:</strong> Ruhe um den Puls zu normalisieren ist KEINE Pause! Sondern NOTWENDIG!
</div>

<div id="rollingWarnBox" class="rolling-warn">⚠️ Achtung: Mehrere Tage im roten Bereich!<br>Auf Rolling PENE aufpassen!</div>

<div class="card">
  <h3>Morgen-Check</h3>
  <input id="sleep" type="number" placeholder="Schlafindex (z.B. 65)">
  <select id="feeling">
    <option value="" disabled selected>Wie fühlst du dich?</option>
    <option value="12">Es geht mir gut (+12)</option>
    <option value="4">Leichter Druck, es geht aber (+4)</option>
    <option value="-6">Starker Druck/Nebel, es geht irgendwie (-6)</option>
    <option value="-12">Schwerer Druck, Pfeifen, es geht nichts (-12)</option>
  </select>
  <button class="btn-full btn-start" onclick="startDay()">Tag starten</button>
  <button class="btn-full btn-reset" onclick="doReset()">Guten Morgen! (Neuer Tag)</button>
</div>

<div class="card">
  <h3>Belastungskatalog (Dauerhaft)</h3>
  <div class="add-row">
    <input id="loadName" class="flex-name" placeholder="Aktivität">
    <input id="loadVal"  class="flex-pts"  type="number" placeholder="Pkt.">
    <button class="btn-add" onclick="addEntry()">Neu</button>
  </div>
  <div class="toolbar">
    <button class="btn-alpha" onclick="sortAlpha()">↕ A–Z sortieren</button>
  </div>
  <div id="catalog" style="margin-top:6px;"></div>
  <p class="sort-hint">☰ Verschieben &nbsp;|&nbsp; ✎ Bearbeiten klappt Zeile auf</p>
</div>

<div class="card">
  <h3>Heutige Aktivitäten</h3>
  <div id="dayList"></div>
  <button class="btn-full btn-undo" onclick="undoLast()">Letzten Eintrag rückgängig</button>
</div>

<script>
// ── Storage ───────────────────────────────────────────────────────────────────
var KEY_LOADS   = "pacing_catalog_data";
var KEY_STATE   = "pacing_daily_state";
var KEY_HISTORY = "pacing_red_history";

// Sicherer Wrapper – funktioniert auch wenn localStorage gesperrt ist
var store = (function() {
    var mem = {}, ok = false;
    try { localStorage.setItem("_t","1"); localStorage.removeItem("_t"); ok = true; } catch(e) {}
    return {
        get: function(k) { try { return ok ? localStorage.getItem(k) : (mem[k]||null); } catch(e) { return mem[k]||null; } },
        set: function(k,v) { try { if(ok) localStorage.setItem(k,v); else mem[k]=v; } catch(e) { mem[k]=v; } }
    };
})();

var loads   = JSON.parse(store.get(KEY_LOADS))   || [{n:"Spaziergang",v:5},{n:"Einkaufen",v:12}];
var state   = JSON.parse(store.get(KEY_STATE))   || {max:0,cur:0,block:0,used:[],date:"",pene:false};
var history = JSON.parse(store.get(KEY_HISTORY)) || [];

function saveAll() {
    store.set(KEY_LOADS, JSON.stringify(loads));
    store.set(KEY_STATE, JSON.stringify(state));
}

// ── Init ──────────────────────────────────────────────────────────────────────
window.onload = function() {
    checkRollingPene();
    var today = new Date().toDateString();
    if (state.date && state.date !== today && state.max > 0) {
        archiveDay();
        resetDayInternal();
        return;
    }
    if (state.max > 0) { showMainUI(); updateDisplay(); }
    renderCatalog();
};

// ── Rolling PENE ──────────────────────────────────────────────────────────────
function checkRollingPene() {
    var red     = history.filter(function(d){ return d; }).length;
    var last2ok = history.length >= 2 && !history[history.length-1] && !history[history.length-2];
    document.getElementById("rollingWarnBox").style.display = (red >= 3 && !last2ok) ? "block" : "none";
}

function archiveDay() {
    var pct = state.max > 0 ? (state.cur / state.max) * 100 : 100;
    history.push(pct <= 25);
    if (history.length > 7) history.shift();
    store.set(KEY_HISTORY, JSON.stringify(history));
}

// ── Tag starten ───────────────────────────────────────────────────────────────
function startDay() {
    var s    = parseFloat(document.getElementById("sleep").value);
    var fStr = document.getElementById("feeling").value;
    if (!fStr || isNaN(s) || s <= 0) {
        showInfo("Bitte Schlafindex (> 0) und Gefühl eingeben.");
        return;
    }
    var max = Math.max(1, s + parseFloat(fStr));
    state = { max:max, cur:max, block:0, used:[], pene:false, date:new Date().toDateString() };
    showMainUI(); saveAll(); updateDisplay();
}

function showMainUI() {
    document.getElementById("statusWrap").style.display = "flex";
    document.getElementById("pauseBtn").style.display   = "block";
    document.getElementById("pauseHint").style.display  = "block";
}

// ── Einfacher Info-Banner (kein alert/confirm) ────────────────────────────────
function showInfo(msg) {
    var b = document.getElementById("infoBanner");
    if (!b) {
        b = document.createElement("div");
        b.id = "infoBanner";
        b.style.cssText = "position:fixed;top:70px;left:12px;right:12px;background:#333;color:#fff;padding:12px 16px;border-radius:12px;font-size:14px;font-weight:600;z-index:9999;text-align:center;";
        document.body.appendChild(b);
    }
    b.textContent = msg;
    b.style.display = "block";
    setTimeout(function(){ b.style.display = "none"; }, 2500);
}

// ── Reset ─────────────────────────────────────────────────────────────────────
function doReset() {
    archiveDay();
    resetDayInternal();
}

function resetDayInternal() {
    state = { max:0, cur:0, block:0, used:[], pene:false, date:"" };
    saveAll();
    document.body.style.background = "#f2f2f7";
    location.reload();
}

// ── Anzeige ───────────────────────────────────────────────────────────────────
function updateDisplay() {
    document.getElementById("valStart").textContent = state.max;
    document.getElementById("valRest").textContent  = state.cur;
    var pct = state.max > 0 ? (state.cur / state.max) * 100 : 0;
    var box = document.getElementById("boxRest");
    var txt = document.getElementById("statusText");
    box.className = "status";
    if      (pct > 75) { box.classList.add("bg-green");  txt.textContent = "Stabil";    document.body.style.background = "#d4f5de"; }
    else if (pct > 50) { box.classList.add("bg-yellow"); txt.textContent = "Achtung";   document.body.style.background = "#fff8cc"; }
    else if (pct > 25) { box.classList.add("bg-orange"); txt.textContent = "Schonung!"; document.body.style.background = "#ffe8c0"; }
    else               { box.classList.add("bg-red");    txt.textContent = "STOPP";     document.body.style.background = "#ffd4d1"; }

    var header = document.getElementById("pacingHeader");
    if (state.block >= 30) {
        header.style.display = "block";
        header.className     = "warn-pene";
        header.innerHTML     = '<span class="blink">⚡ PAUSE ERZWINGEN! ⚡</span><br><small>Block: ' + state.block + '</small>';
        if (!state.pene) {
            state.cur  = Math.max(0, state.cur - 1);
            state.used.push({n:"⚠️ STRAFE: PENE-Warnung", v:1, t:nowTime()});
            state.pene = true;
            saveAll();
        }
    } else if (state.block >= 20) {
        header.style.display = "block";
        header.className     = "warn-rot";
        header.innerHTML     = "PAUSE EMPFOHLEN! (Block: " + state.block + ")";
        state.pene = false;
    } else {
        header.style.display = "none";
        state.pene = false;
    }
    renderUsed();
}

function nowTime() {
    return new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
}

// ── Aktivitätsliste ───────────────────────────────────────────────────────────
function renderUsed() {
    var div  = document.getElementById("dayList");
    div.innerHTML = "";
    var list = state.used.slice().reverse();
    for (var j = 0; j < list.length; j++) {
        var u       = list[j];
        var isWarn  = u.n.indexOf("STRAFE") >= 0;
        var isPause = u.v < 0;
        var row   = document.createElement("div");
        row.className = "item";
        var left  = document.createElement("span");
        var tl    = document.createElement("span");
        tl.className   = "time-label";
        tl.textContent = u.t || "";
        var nl = document.createElement("span");
        if (isWarn) { nl.style.color = "var(--red)"; nl.style.fontWeight = "bold"; }
        nl.textContent = u.n;
        left.appendChild(tl); left.appendChild(nl);
        var right = document.createElement("span");
        right.style.color = isPause ? "var(--green)" : "var(--red)";
        right.textContent = (isPause ? "+" : "-") + Math.abs(u.v);
        row.appendChild(left); row.appendChild(right);
        div.appendChild(row);
    }
}

// ── Aktivität buchen ──────────────────────────────────────────────────────────
function applyLoad(i) {
    if (state.max <= 0) { showInfo("Bitte erst den Tag starten!"); return; }
    state.cur   = Math.max(0, state.cur - loads[i].v);
    state.block = state.block + loads[i].v;
    state.used.push({n:loads[i].n, v:loads[i].v, t:nowTime()});
    saveAll(); updateDisplay();
}

// ── Pause ─────────────────────────────────────────────────────────────────────
function doPause() {
    state.cur   = Math.min(state.max, state.cur + 3);
    state.block = 0; state.pene = false;
    state.used.push({n:"☕ Pause / Erholung", v:-3, t:nowTime()});
    saveAll(); updateDisplay();
}

// ── Rückgängig ────────────────────────────────────────────────────────────────
function undoLast() {
    if (state.used.length === 0) return;
    var last = state.used.pop();
    if (last.n.indexOf("STRAFE") >= 0) {
        state.cur  = Math.min(state.max, state.cur + last.v);
        state.pene = false;
    } else if (last.v < 0) {
        state.cur   = Math.max(0, state.cur + last.v);
        state.block = 0;
    } else {
        state.cur   = Math.min(state.max, state.cur + last.v);
        state.block = Math.max(0, state.block - last.v);
    }
    saveAll(); updateDisplay();
}

// ── Katalog: Hinzufügen / Sortieren ──────────────────────────────────────────
function addEntry() {
    var n = document.getElementById("loadName").value.trim();
    var v = parseFloat(document.getElementById("loadVal").value);
    if (!n || isNaN(v) || v === 0) return;
    loads.push({n:n, v:v});
    saveAll(); renderCatalog();
    document.getElementById("loadName").value = "";
    document.getElementById("loadVal").value  = "";
}

function sortAlpha() {
    loads.sort(function(a,b){ return a.n.localeCompare(b.n, "de"); });
    saveAll(); renderCatalog();
}

// ── Katalog: Inline-Edit öffnen/schließen ─────────────────────────────────────
function openEdit(idx) {
    // Schließe alle anderen offenen Edit-Zeilen
    var all = document.querySelectorAll(".edit-row.open");
    for (var k = 0; k < all.length; k++) all[k].classList.remove("open");

    var er = document.getElementById("edit-row-" + idx);
    if (er) {
        er.classList.add("open");
        er.querySelector(".en").focus();
    }
}

function closeEdit(idx) {
    var er = document.getElementById("edit-row-" + idx);
    if (er) er.classList.remove("open");
}

function saveEdit(idx) {
    var er = document.getElementById("edit-row-" + idx);
    if (!er) return;
    var n = er.querySelector(".en").value.trim();
    var v = parseFloat(er.querySelector(".ev").value);
    if (!n || isNaN(v) || v === 0) { showInfo("Name und Punkte ausfüllen!"); return; }
    loads[idx] = {n:n, v:v};
    saveAll(); renderCatalog();
}

function deleteEntry(idx) {
    loads.splice(idx, 1);
    saveAll(); renderCatalog();
}

// ── Katalog rendern ───────────────────────────────────────────────────────────
var dragSrc       = null;
var activeDragRow = null;

// Einmaliger globaler mouseup
document.addEventListener("mouseup", function() {
    if (activeDragRow) { activeDragRow.draggable = false; activeDragRow = null; }
});

function renderCatalog() {
    var container = document.getElementById("catalog");
    container.innerHTML = "";

    for (var i = 0; i < loads.length; i++) {
        (function(idx, load) {

            // ── Haupt-Zeile ──
            var row = document.createElement("div");
            row.className   = "item";
            row.dataset.idx = String(idx);

            var handle = document.createElement("span");
            handle.className   = "drag-handle";
            handle.textContent = "☰";

            handle.addEventListener("mousedown", function() {
                row.draggable = true;
                activeDragRow = row;
            });
            row.addEventListener("dragstart", function(e) {
                if (!row.draggable) { e.preventDefault(); return; }
                dragSrc = idx;
                e.dataTransfer.effectAllowed = "move";
                setTimeout(function(){ row.classList.add("dragging"); }, 0);
            });
            row.addEventListener("dragend", function() {
                row.draggable = false; activeDragRow = null;
                row.classList.remove("dragging");
                clearDragOver();
            });
            row.addEventListener("dragover", function(e) {
                e.preventDefault(); clearDragOver();
                row.classList.add("drag-over");
            });
            row.addEventListener("drop", function(e) {
                e.preventDefault();
                if (dragSrc === null || dragSrc === idx) return;
                var moved = loads.splice(dragSrc, 1)[0];
                loads.splice(idx, 0, moved);
                dragSrc = null; saveAll(); renderCatalog();
            });

            // Touch-Drag
            var touchSrc = null;
            handle.addEventListener("touchstart", function() {
                touchSrc = idx; row.classList.add("dragging");
            }, {passive:true});
            handle.addEventListener("touchmove", function(e) {
                e.preventDefault();
                var el  = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
                var tgt = el ? el.closest(".item") : null;
                clearDragOver();
                if (tgt && tgt !== row) tgt.classList.add("drag-over");
            }, {passive:false});
            handle.addEventListener("touchend", function(e) {
                row.classList.remove("dragging");
                var el  = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
                var tgt = el ? el.closest(".item[data-idx]") : null;
                if (tgt && touchSrc !== null) {
                    var target = parseInt(tgt.dataset.idx, 10);
                    if (touchSrc !== target) {
                        var moved = loads.splice(touchSrc, 1)[0];
                        loads.splice(target, 0, moved);
                        saveAll(); renderCatalog(); return;
                    }
                }
                clearDragOver(); touchSrc = null;
            }, {passive:true});

            var nameSpan = document.createElement("span");
            nameSpan.className = "item-name";
            nameSpan.innerHTML = "<strong>" + load.n + "</strong> (" + load.v + ")";
            nameSpan.onclick = function() { applyLoad(idx); };

            var btns = document.createElement("div");
            btns.className = "item-btns";

            var bApply = document.createElement("button");
            bApply.className = "btn-sm"; bApply.style.background = "var(--blue)";
            bApply.textContent = "+";
            bApply.onclick = function() { applyLoad(idx); };

            var bEdit = document.createElement("button");
            bEdit.className = "btn-sm"; bEdit.style.background = "var(--gray)";
            bEdit.textContent = "✎";
            bEdit.onclick = function() { openEdit(idx); };

            btns.appendChild(bApply);
            btns.appendChild(bEdit);
            row.appendChild(handle);
            row.appendChild(nameSpan);
            row.appendChild(btns);
            container.appendChild(row);

            // ── Inline-Edit-Zeile (direkt darunter) ──
            var er = document.createElement("div");
            er.className = "edit-row";
            er.id        = "edit-row-" + idx;

            var inName = document.createElement("input");
            inName.type        = "text";
            inName.className   = "en";
            inName.value       = load.n;
            inName.placeholder = "Name";

            var inVal = document.createElement("input");
            inVal.type        = "number";
            inVal.className   = "ev pts";
            inVal.value       = load.v;
            inVal.placeholder = "Pkt.";

            var bSave = document.createElement("button");
            bSave.className   = "save-btn";
            bSave.textContent = "✔ Speichern";
            bSave.onclick     = function() { saveEdit(idx); };

            var bDel = document.createElement("button");
            bDel.className   = "del-btn";
            bDel.textContent = "✕ Löschen";
            bDel.onclick     = function() { deleteEntry(idx); };

            var bCan = document.createElement("button");
            bCan.className   = "can-btn";
            bCan.textContent = "✕";
            bCan.onclick     = function() { closeEdit(idx); };

            er.appendChild(inName);
            er.appendChild(inVal);
            er.appendChild(bSave);
            er.appendChild(bDel);
            er.appendChild(bCan);
            container.appendChild(er);

        })(i, loads[i]);
    }
}

function clearDragOver() {
    var els = document.querySelectorAll(".drag-over");
    for (var k = 0; k < els.length; k++) els[k].classList.remove("drag-over");
}
</script>

</body>
</html>