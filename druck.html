<!DOCTYPE html>

<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Belastungskonto 3.7</title>

<style>
:root{
--green:#34c759; --yellow:#ffcc00; --orange:#ff9500; --red:#ff3b30;
--blue:#007aff; --gray:#8e8e93; --pause:#5856d6;
}
body{font-family:-apple-system,system-ui,sans-serif;background:#f2f2f7;margin:0;padding:12px;padding-top:85px}
.card{background:#fff;border-radius:16px;padding:16px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,.08)}
button{width:100%;padding:14px;border:none;border-radius:12px;font-weight:700;font-size:16px;color:#fff;cursor:pointer; transition: opacity 0.2s;}
button:active{opacity: 0.7;}

.btn-start{background:var(--blue);margin-top:12px}
.btn-reset{background:var(--gray);margin-top:8px; font-size: 13px;}
.btn-add{background:var(--green); width: auto; padding: 10px 14px; margin-top:6px;}
.btn-pause{background:var(--pause);margin-bottom:4px;display:none}

.pause-hint { display: none; font-size: 12px; color: #555; background: #e5e5ea; padding: 8px; border-radius: 8px; margin-bottom: 12px; line-height: 1.4; border-left: 4px solid var(--pause); }

#pacingHeader { position:fixed; top:0; left:0; width:100%; padding:10px; text-align:center; font-weight:800; z-index:2000; display:none; box-shadow: 0 2px 10px rgba(0,0,0,0.2); box-sizing: border-box; }
.warn-rot { background: var(--red); color: #fff; border-bottom: 2px solid rgba(0,0,0,0.2); }
.warn-pene { background: #000; color: var(--yellow); border-bottom: 3px solid var(--red); }
.blink { animation: blinker 0.9s linear infinite; }
@keyframes blinker { 50% { opacity: 0.3; } }

.rolling-warn { background: #ffedea; border: 2px solid var(--red); color: var(--red); padding: 12px; border-radius: 12px; font-weight: bold; margin-bottom: 15px; display: none; text-align: center; }

.status-wrap{display:none;gap:10px;margin-bottom:12px}
.status{flex:1;border-radius:14px;padding:14px;color:#fff;font-weight:800;text-align:center}
.big{font-size:2rem; display:block; margin:5px 0}
.bg-green{background:var(--green)}
.bg-yellow{background:var(--yellow);color:#000}
.bg-orange{background:var(--orange)}
.bg-red{background:var(--red)}

.item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #eee}
.clickable-name{flex-grow:1;cursor:pointer;padding:8px 0; font-size: 16px;}
.small-btn{width:38px; height:38px; padding:0; font-size:16px; border-radius:10px; margin-left:6px; display:inline-flex; align-items:center; justify-content:center;}
.time-label { font-size: 11px; color: var(--gray); margin-right: 8px; font-weight: 400; }

input,select{width:100%;padding:12px;border:1px solid #d1d1d6;border-radius:10px;font-size:16px;margin-top:6px;box-sizing:border-box}

.add-input-row { display: flex; gap: 6px; align-items: flex-end; }
.flex-name { flex: 2; }
.flex-pts { flex: 0.8; min-width: 50px; }
.flex-btn { flex: 0.5; }
</style>

</head>

<body>

<div id="pacingHeader"></div>

<div id="statusWrap" class="status-wrap">
<div class="status bg-green">Tageslimit<span id="valStart" class="big">0</span></div>
<div id="boxRest" class="status bg-green">Rest-Energie<span id="valRest" class="big">0</span><span id="statusText"></span></div>
</div>

<button id="pauseBtn" class="btn-pause" onclick="doPause()">☕ PAUSE (+3 & Block-Reset)</button>

<div id="pauseHint" class="pause-hint">
<strong>Hinweis:</strong> Ruhe, um den Puls zu normalisieren ist KEINE Pause! Sondern NOTWENDIG!
</div>

<div id="rollingWarnBox" class="rolling-warn">⚠️ Achtung: Mehrere Tage im roten Bereich!<br>Auf Rolling PENE aufpassen!</div>

<div class="card">
<h3>Morgen-Check</h3>
<input id="sleep" type="number" placeholder="Schlafindex (z.B. 65)">
<select id="feeling">
<option value="" disabled selected>Wie fühlst du dich?</option>
<option value="12">Es geht mir gut (+12)</option>
<option value="4">Leichter Druck, es geht aber (+4)</option>
<option value="-6">Starker Druck/Nebel, es geht irgendwie (-6)</option>
<option value="-12">Schwerer Druck, Pfeifen, es geht nichts (-12)</option>
</select>
<button class="btn-start" onclick="startDay()">Tag starten</button>
<button class="btn-reset" onclick="resetDay()">Guten Morgen! (Neuer Tag)</button>
</div>

<div class="card">
<h3>Belastungskatalog (Dauerhaft)</h3>
<div class="add-input-row">
<input id="loadName" class="flex-name" placeholder="Aktivität">
<input id="loadVal" class="flex-pts" type="number" placeholder="Pkt.">
<button class="btn-add flex-btn" onclick="addCatalogEntry()">Neu</button>
</div>
<div id="catalog" style="margin-top: 15px;"></div>
</div>

<div class="card">
<h3>Heutige Aktivitäten</h3>
<div id="dayList"></div>
<button onclick="undoLast()" style="background:var(--orange);width:100%;padding:14px;border:none;border-radius:12px;font-weight:700;color:#fff;margin-top:15px">Letzten Eintrag rückgängig</button>
</div>

<script>
const STORAGE_LOADS = "pacing_catalog_data"
const STORAGE_STATE = "pacing_daily_state"
const STORAGE_HISTORY = "pacing_red_history"

let loads = JSON.parse(localStorage.getItem(STORAGE_LOADS)) || [{n: "Spaziergang", v: 5}, {n: "Einkaufen", v: 12}];
let state = JSON.parse(localStorage.getItem(STORAGE_STATE)) || { max: 0, cur: 0, block: 0, used: [], date: "", pene: false };
let history = JSON.parse(localStorage.getItem(STORAGE_HISTORY)) || [];

window.onload = function() {
checkRollingPene();
const today = new Date().toDateString();
if (state.date && state.date !== today && state.max > 0) {
if(confirm("Guten Morgen! Neuen Tag beginnen?")) {
archiveDay();
resetDayInternal();
}
}
if (state.max > 0) {
showMainUI();
updateDisplay();
}
renderCatalog();
};

function checkRollingPene() {
const redDays = history.filter(d => d).length;
const lastTwoNotRed = history.length >= 2 && !history[history.length-1] && !history[history.length-2];
if (redDays >= 3 && !lastTwoNotRed) {
document.getElementById("rollingWarnBox").style.display = "block"
} else {
document.getElementById("rollingWarnBox").style.display = "none"
}
}

function archiveDay() {
const percent = (state.cur / state.max) * 100;
const endedRed = percent <= 25;
history.push(endedRed);
if (history.length > 7) history.shift();
localStorage.setItem(STORAGE_HISTORY, JSON.stringify(history));
}

function saveAll() {
localStorage.setItem(STORAGE_LOADS, JSON.stringify(loads));
localStorage.setItem(STORAGE_STATE, JSON.stringify(state));
}

function startDay() {
const s = +document.getElementById("sleep").value;
const fStr = document.getElementById("feeling").value;
if(fStr === "" || isNaN(s) || s <= 0) return alert("Bitte einen gültigen Schlafindex (> 0) und Gefühl eingeben.");
state.max = Math.max(1, s + (+fStr));
state.cur = state.max;
state.used = []; state.block = 0; state.pene = false;
state.date = new Date().toDateString();
showMainUI(); saveAll(); updateDisplay();
}

function showMainUI() {
document.getElementById("statusWrap").style.display = "flex"
document.getElementById("pauseBtn").style.display = "block"
document.getElementById("pauseHint").style.display = "block"
}

function updateDisplay() {
document.getElementById("valStart").textContent = state.max;
document.getElementById("valRest").textContent = state.cur;
const p = (state.cur / state.max) * 100;
const box = document.getElementById("boxRest"), txt = document.getElementById("statusText");
box.className = "status"
if(p > 75) { box.classList.add("bg-green"); txt.textContent="Stabil" }
else if(p > 50) { box.classList.add("bg-yellow"); txt.textContent="Achtung" }
else if(p > 25) { box.classList.add("bg-orange"); txt.textContent="Schonung!" }
else { box.classList.add("bg-red"); txt.textContent="STOPP" }

const header = document.getElementById("pacingHeader");
if (state.block >= 30) {
header.style.display = "block"
header.className = "warn-pene"
header.innerHTML = `<span class="blink">⚡ PAUSE ERZWINGEN! ⚡</span><br><small>Block: ${state.block}</small>`;
if(!state.pene) {
state.cur = Math.max(0, state.cur - 1);
state.used.push({n: "⚠️ STRAFE: PENE-Warnung", v: 1, t: nowTime()});
state.pene = true;
saveAll();
}
} else if (state.block >= 20) {
header.style.display = "block"
header.className = "warn-rot"
header.innerHTML = `PAUSE EMPFOHLEN! (Block: ${state.block})`;
state.pene = false;
} else { header.style.display = "none" state.pene = false; }
renderUsed();
}

function nowTime() { return new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); }

function addCatalogEntry() {
const n = document.getElementById("loadName").value.trim();
const v = +document.getElementById("loadVal").value;
if(!n || !v) return;
loads.push({n, v});
saveAll(); renderCatalog();
document.getElementById("loadName").value = ""
document.getElementById("loadVal").value = ""
}

function renderCatalog() {
const div = document.getElementById("catalog");
div.innerHTML = ""
loads.forEach((l, i) => {
div.innerHTML += `<div class="item"><span class="clickable-name" onclick="applyLoad(${i})"><strong>${l.n}</strong> (${l.v})</span><div><button class="small-btn" style="background:var(--blue)" onclick="applyLoad(${i})">+</button><button class="small-btn" style="background:var(--gray)" onclick="editCatalog(${i})">✎</button><button class="small-btn" style="background:var(--red)" onclick="deleteCatalog(${i})">✕</button></div></div>`;
});
}

function applyLoad(i) {
if(state.max <= 0) return alert("Bitte erst den Tag starten!");
state.cur = Math.max(0, state.cur - loads[i].v);
state.block += loads[i].v;
state.used.push({...loads[i], t: nowTime()});
saveAll(); updateDisplay();
}

function renderUsed() {
const div = document.getElementById("dayList"); div.innerHTML = ""
state.used.slice().reverse().forEach(u => {
const isWarn = u.n.includes("STRAFE"), isPause = u.v < 0;
div.innerHTML += `<div class="item"><span><span class="time-label">${u.t || ''}</span> <span style="${isWarn?'color:var(--red);font-weight:bold':''}">${u.n}</span></span><span style="color:${isPause?'var(--green)':'var(--red)'}">${isPause?'+':'-'}${Math.abs(u.v)}</span></div>`;
});
}

function doPause() {
state.cur = Math.min(state.max, state.cur + 3);
state.block = 0; state.pene = false;
state.used.push({n: "☕ Pause / Erholung", v: -3, t: nowTime()});
saveAll(); updateDisplay();
}

function undoLast() {
if(state.used.length === 0) return;
const last = state.used.pop();
if(last.n.includes("STRAFE")) { state.cur = Math.min(state.max, state.cur + last.v); state.pene = false; }
else if(last.v < 0) { state.cur = Math.max(0, state.cur + last.v); state.block = 0; }
else { state.cur = Math.min(state.max, state.cur + last.v); state.block = Math.max(0, state.block - last.v); }
saveAll(); updateDisplay();
}

function resetDay() {
if(!confirm("Wirklich einen neuen Tag beginnen? Alle heutigen Daten werden archiviert.")) return;
archiveDay();
resetDayInternal();
}

function resetDayInternal() {
state = {max:0, cur:0, used:[], block:0, pene:false, date:""};
saveAll();
document.getElementById("sleep").value = ""
document.getElementById("feeling").selectedIndex = 0;
location.reload();
}

function editCatalog(i) {
const n = prompt("Name:", loads[i].n), v = prompt("Punkte:", loads[i].v);
if(n && v && !isNaN(+v)) { loads[i] = {n, v: +v}; saveAll(); renderCatalog(); }
}

function deleteCatalog(i) {
if(confirm("Löschen?")) { loads.splice(i, 1); saveAll(); renderCatalog(); }
}
</script>

</body>
</html>
